import{d as ye,p as Pe,r as d,v as he,b as p,e as J,f as W,w as o,i as l,h as ge,j as i,u as De,a3 as G,ac as Te,o as Oe,k as S,l as D,t as T,E as me,aC as Ae,c as Be,aL as Fe,aM as _e,g as $e,ak as Le,ah as ze,as as Z,aN as Ke,aO as Re,ae as xe,aE as Ge,aK as Qe,aP as je,aJ as Me}from"./index-CfDPjNFe.js";import{S as He}from"./sortable.esm-BmjBFecF.js";import{c as Je,t as de,e as We,f as ce}from"./tree-VGRVvCJj.js";import{z as Ie,A as Xe,B as Ye,C as Ue,b as pe,D as Ze,E as el,F as ll,G as al,H as we,I as tl}from"./user-ClNn6o5G.js";import{_ as nl,a as ue,b as ol,c as sl}from"./QueryItem.vue_vue_type_script_setup_true_lang-BiDqtMxm.js";import{_ as dl}from"./DialogForm.vue_vue_type_script_setup_true_lang-BMzG1_v9.js";import{b as il}from"./data-CtWb6y_Y.js";import{m as rl}from"./content-SKd4otdD.js";const ul=ye({name:"OrgForm",__name:"OrgForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},beanIds:{type:Array,required:!0},parentId:{type:String,required:!0},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(Q,{emit:j}){const E=Q,{parentId:O,beanId:C,showGlobalData:_,modelValue:F}=Pe(E),L=j,I=d(),f=d({}),y=d([]),N=async m=>{y.value=Je(de(await pe({current:!_.value})),m==null?void 0:m.id)},z=async m=>{await N(m),L("finished")};return he(F,()=>{F.value&&N()}),(m,r)=>{const K=p("el-tree-select"),$=p("el-form-item"),h=p("el-input");return J(),W(dl,{values:f.value,"onUpdate:values":r[5]||(r[5]=g=>f.value=g),name:m.$t("menu.user.org"),"query-bean":i(Ie),"create-bean":i(Xe),"update-bean":i(Ye),"delete-bean":i(Ue),"bean-id":i(C),"bean-ids":Q.beanIds,focus:I.value,"init-values":g=>({parentId:i(O)}),"to-values":g=>({...g}),"disable-delete":g=>{var w;return g.id<=1||g.id===((w=y.value[0])==null?void 0:w.id)},perms:"org","model-value":Q.modelValue,"onUpdate:modelValue":r[6]||(r[6]=g=>m.$emit("update:modelValue",g)),onFinished:z,onBeanChange:r[7]||(r[7]=()=>N())},{default:o(({isEdit:g})=>{var w;return[!g||f.value.id!==((w=y.value[0])==null?void 0:w.id)?(J(),W($,{key:0,prop:"parentId",label:m.$t("org.parent"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(K,{modelValue:f.value.parentId,"onUpdate:modelValue":r[0]||(r[0]=c=>f.value.parentId=c),data:y.value,"node-key":"id",props:{label:"name",disabled:"disabled"},"default-expanded-keys":y.value.map(c=>c.id),"render-after-expand":!1,disabled:g,"check-strictly":"",class:"w-full"},null,8,["modelValue","data","default-expanded-keys","disabled"])]),_:2},1032,["label","rules"])):ge("",!0),l($,{prop:"name",label:m.$t("org.name"),rules:{required:!0,message:()=>m.$t("v.required")}},{default:o(()=>[l(h,{ref_key:"focus",ref:I,modelValue:f.value.name,"onUpdate:modelValue":r[1]||(r[1]=c=>f.value.name=c),maxlength:"50"},null,8,["modelValue"])]),_:1},8,["label","rules"]),l($,{prop:"address",label:m.$t("org.address")},{default:o(()=>[l(h,{modelValue:f.value.address,"onUpdate:modelValue":r[2]||(r[2]=c=>f.value.address=c),maxlength:"255"},null,8,["modelValue"])]),_:1},8,["label"]),l($,{prop:"phone",label:m.$t("org.phone")},{default:o(()=>[l(h,{modelValue:f.value.phone,"onUpdate:modelValue":r[3]||(r[3]=c=>f.value.phone=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"]),l($,{prop:"contacts",label:m.$t("org.contacts")},{default:o(()=>[l(h,{modelValue:f.value.contacts,"onUpdate:modelValue":r[4]||(r[4]=c=>f.value.contacts=c),maxlength:"100"},null,8,["modelValue"])]),_:1},8,["label"])]}),_:1},8,["values","name","query-bean","create-bean","update-bean","delete-bean","bean-id","bean-ids","focus","init-values","to-values","disable-delete","model-value"])}}}),ml={class:"border-t"},cl={class:"border-t"},pl={class:"border-t"},vl={class:"flex items-center justify-between"},fl=ye({name:"OrgPermissionForm",__name:"OrgPermissionForm",props:{modelValue:{type:Boolean,required:!0},beanId:{type:String,default:null},showGlobalData:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finished:null},setup(Q,{emit:j}){var re;const E=Q,O=j,{beanId:C,modelValue:_}=Pe(E),{t:F}=De(),L=d("articlePermission"),I=d(),f=d({}),y=d({}),N=d(!1),z=d(!1),m=d(!1),r=d(),K=d(!1),$=d(!1),h=d(),g=d(!1),w=d(!1),c=d(),A=il();We(A,(re=G.grantPermissions)!=null?re:[]);const U=d([]),q=d([]),P=Te(()=>f.value.global&&!G.globalPermission||G.rank>f.value.rank),ee=async()=>{C.value!=null&&(f.value=await Ie(C.value),y.value={...f.value})},ve=async()=>{var s;if(C.value!=null){const a=await el(C.value);(s=r.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var v;(v=r.value)==null||v.setChecked(k,!0,!1)})}},fe=async()=>{var s;if(C.value!=null){const a=await ll(C.value);(s=h.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var v;(v=h.value)==null||v.setChecked(k,!0,!1)})}},le=async()=>{var s;if(C.value!=null){const a=await al(C.value,E.showGlobalData);(s=c.value)==null||s.setCheckedKeys([]),a.forEach(k=>{var v;(v=c.value)==null||v.setChecked(k,!0,!1)})}},be=async()=>{U.value=de(await rl())},ie=async()=>{q.value=de(await pe({current:!0}))};he(_,async()=>{_.value&&(ee(),ve(),fe(),le())}),Oe(()=>{be(),ie()});const ae=()=>{I.value.validate(async s=>{if(s){N.value=!0;try{X(),ne(),oe(),await Ze(y.value),O("finished"),O("update:modelValue",!1),me.success(F("success"))}finally{N.value=!1}}})},M=(s,a,k,v)=>{k.forEach(e=>{e.children&&(a.getNode(e[v!=null?v:"key"]).expanded=s,M(s,a,e.children,v))})},te=(s,a,k,v)=>{a.setCheckedKeys(s?k.map(e=>e[v!=null?v:"key"]):[])},X=()=>{r.value!=null&&(y.value.articlePermissions=[...r.value.getCheckedNodes(),...r.value.getHalfCheckedNodes()].map(s=>s.id))},ne=()=>{h.value!=null&&(y.value.channelPermissions=[...h.value.getCheckedNodes(),...h.value.getHalfCheckedNodes()].map(s=>s.id))},oe=()=>{c.value!=null&&(y.value.orgPermissions=c.value.getCheckedNodes().map(s=>s.id))};return(s,a)=>{const k=p("el-checkbox"),v=p("el-tree"),e=p("el-tab-pane"),t=p("el-tabs"),V=p("el-form"),b=p("el-tag"),H=p("el-button"),B=p("el-drawer");return J(),W(B,{title:s.$t("permissionSettings"),"with-header":!1,"model-value":Q.modelValue,size:576,"onUpdate:modelValue":a[18]||(a[18]=n=>s.$emit("update:modelValue",n))},{default:o(()=>[l(V,{ref_key:"form",ref:I,model:y.value,disabled:P.value,"label-width":"150px"},{default:o(()=>[l(t,{modelValue:L.value,"onUpdate:modelValue":a[15]||(a[15]=n=>L.value=n)},{default:o(()=>[l(e,{label:s.$t("org.articlePermission"),name:"articlePermission"},{default:o(()=>[S("div",ml,[l(k,{modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=n=>z.value=n),label:s.$t("expand/collapse"),onChange:a[1]||(a[1]=n=>M(n,r.value,U.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:m.value,"onUpdate:modelValue":a[2]||(a[2]=n=>m.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[3]||(a[3]=n=>{te(n,r.value,i(ce)(U.value),"id"),X()})},null,8,["modelValue","label"])]),l(v,{ref_key:"articlePermissionTree",ref:r,data:U.value,"node-key":"id",props:{label:"name"},class:"border rounded","show-checkbox":"",onCheck:a[4]||(a[4]=()=>X())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("role.channelPermission"),name:"channelPermission"},{default:o(()=>[S("div",cl,[l(k,{modelValue:K.value,"onUpdate:modelValue":a[5]||(a[5]=n=>K.value=n),label:s.$t("expand/collapse"),onChange:a[6]||(a[6]=n=>M(n,h.value,U.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:$.value,"onUpdate:modelValue":a[7]||(a[7]=n=>$.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[8]||(a[8]=n=>{te(n,h.value,i(ce)(U.value),"id"),ne()})},null,8,["modelValue","label"])]),l(v,{ref_key:"channelPermissionTree",ref:h,data:U.value,"node-key":"id",props:{label:"name"},class:"border rounded","check-strictly":"","show-checkbox":"",onCheck:a[9]||(a[9]=()=>ne())},null,8,["data"])]),_:1},8,["label"]),l(e,{label:s.$t("org.orgPermission"),name:"orgPermission"},{default:o(()=>[S("div",pl,[l(k,{modelValue:g.value,"onUpdate:modelValue":a[10]||(a[10]=n=>g.value=n),label:s.$t("expand/collapse"),onChange:a[11]||(a[11]=n=>M(n,c.value,q.value,"id"))},null,8,["modelValue","label"]),l(k,{modelValue:w.value,"onUpdate:modelValue":a[12]||(a[12]=n=>w.value=n),label:s.$t("checkAll/uncheckAll"),onChange:a[13]||(a[13]=n=>{te(n,c.value,i(ce)(q.value),"id"),oe()})},null,8,["modelValue","label"])]),l(v,{ref_key:"orgPermissionTree",ref:c,data:q.value,"node-key":"id",props:{label:"name"},class:"border rounded","default-expanded-keys":q.value.map(n=>n.id),"show-checkbox":"","check-strictly":"",onCheck:a[14]||(a[14]=()=>oe())},null,8,["data","default-expanded-keys"])]),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["model","disabled"])]),footer:o(()=>[S("div",vl,[S("div",null,[l(b,null,{default:o(()=>{var n;return[D(T((n=y.value)==null?void 0:n.name),1)]}),_:1})]),S("div",null,[l(H,{onClick:a[16]||(a[16]=()=>s.$emit("update:modelValue",!1))},{default:o(()=>[D(T(s.$t("cancel")),1)]),_:1}),l(H,{type:"primary",loading:N.value,disabled:P.value,onClick:a[17]||(a[17]=()=>ae())},{default:o(()=>[D(T(s.$t("save")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["title","model-value"])}}}),bl={class:"flex justify-between mx-2 mt-1"},gl={class:"mb-3"},yl={class:"mt-3 app-block"},Dl=ye({name:"OrgList",__name:"OrgList",setup(Q){const{t:j}=De(),E=d({}),O=d(),C=d(),_=d([]),F=d([]),L=d(!1),I=d(!1),f=d(!1),y=d(),N=Te(()=>ce(_.value).map(e=>e.id)),z=d("1"),m=d(!1),r=d(),K=d(!1),$=d(!1),h=d(),g=d([]),w=d(!1),c=d(),A=d();he(c,e=>{h.value.filter(e)});const U=async()=>{w.value=!0;try{g.value=de(await pe({current:!m.value})),je(()=>{var e;c.value!=null&&h.value.filter(c.value),h.value.setCurrentKey((e=A.value)==null?void 0:e.id)})}finally{w.value=!1}},q=async()=>{var e,t;L.value=!0;try{K.value=O.value!==void 0;const V=Object.values(E.value).filter(b=>b!==void 0&&b!=="").length>0;_.value=await pe({...Me(E.value),parentId:(e=A.value)==null?void 0:e.id,current:!m.value,isIncludeSelf:!0,isIncludeChildren:V,Q_OrderBy:O.value}),!V&&!K.value?(_.value=de(_.value),r.value=_.value.map(b=>b.id)):r.value=void 0,z.value=(t=_.value[0])==null?void 0:t.id}finally{L.value=!1}},P=()=>{U(),q()};let ee;const ve=()=>{const e=document.querySelector("#dataTable .el-table__body-wrapper tbody");ee=He.create(e,{handle:".drag-handle",draggable:".drag-draggable",animation:200,chosenClass:"sortable-chosen",onEnd:async function(t){var H;const{oldIndex:V,newIndex:b}=t;if(V!==b){let B=V,n=b,R=_.value;const Y=(H=R[0])==null?void 0:H.children;(Y==null?void 0:Y.length)>0&&(R=Y,B-=1,n-=1),await we(R[B].id,R[n].id,B>n?"before":"after"),U(),R.splice(n,0,R.splice(B,1)[0]),me.success(j("success"))}}})};Oe(()=>{P(),ve()}),Ae(()=>{ee!==void 0&&ee.destroy()});const fe=({column:e,prop:t,order:V})=>{var b;t&&V?O.value=((b=e.sortBy)!=null?b:t)+(V==="descending"?"_desc":""):O.value=void 0,P()},le=()=>q(),be=()=>{C.value.clearSort(),Qe(E.value),O.value=void 0,P()},ie=e=>{y.value=void 0,e!=null&&(z.value=e),I.value=!0},ae=e=>{y.value=e,I.value=!0},M=async e=>{await Ue(e),P(),me.success(j("success"))},te=e=>{y.value=e,f.value=!0},X=e=>e.id>1,ne=async(e,t,V)=>{V!=="none"&&(await we(e.data.id,t.data.id,V),q())},oe=async()=>{await tl(),P(),me.success(j("success"))},re=async e=>{$.value?(A.value!=e.parent&&(A.value=e.parent,await q()),ae(e.id)):(A.value=e,le())},s=(e,t)=>e?t.name.includes(e):!0,a=()=>{h.value.setCurrentKey(null),A.value=void 0,le()},k=e=>g.value.findIndex(t=>t.id===e.data.id)===-1,v=(e,t)=>g.value.findIndex(V=>V.id===t.data.id)===-1;return(e,t)=>{const V=p("el-input"),b=p("el-button"),H=p("el-switch"),B=p("el-tooltip"),n=p("el-tree"),R=p("el-scrollbar"),Y=p("el-aside"),ke=p("el-popconfirm"),Ve=p("el-icon"),qe=p("el-checkbox"),x=p("el-table-column"),Se=p("el-table"),Ee=p("el-main"),Ne=p("el-container"),Ce=Be("loading");return J(),W(Ne,null,{default:o(()=>[l(Y,{width:"220px",class:"pr-3"},{default:o(()=>[l(R,{class:"p-2 bg-white rounded-sm"},{default:o(()=>[l(V,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=u=>c.value=u),"suffix-icon":i(Fe),size:"small"},null,8,["modelValue","suffix-icon"]),S("div",bl,[l(b,{type:A.value==null?"primary":void 0,link:"",onClick:a},{default:o(()=>[D(T(e.$t("org.root")),1)]),_:1},8,["type"]),l(B,{content:e.$t("editMode"),placement:"top"},{default:o(()=>[l(H,{modelValue:$.value,"onUpdate:modelValue":t[1]||(t[1]=u=>$.value=u),"active-action-icon":i(_e),"inactive-action-icon":i(_e)},null,8,["modelValue","active-action-icon","inactive-action-icon"])]),_:1},8,["content"])]),$e(l(n,{ref_key:"orgTree",ref:h,data:g.value,props:{label:"name"},"default-expanded-keys":r.value,"expand-on-click-node":!1,"node-key":"id","highlight-current":"",draggable:"","allow-drag":k,"allow-drop":v,"filter-node-method":s,onNodeClick:re,onNodeDragEnd:ne},null,8,["data","default-expanded-keys"]),[[Ce,w.value]])]),_:1})]),_:1}),l(Ee,{class:"p-0"},{default:o(()=>[S("div",gl,[l(i(nl),{params:E.value,onSearch:le,onReset:be},{default:o(()=>[l(i(ue),{label:e.$t("org.name"),name:"Q_Contains_name"},null,8,["label"]),l(i(ue),{label:e.$t("org.address"),name:"Q_Contains_address"},null,8,["label"]),l(i(ue),{label:e.$t("org.phone"),name:"Q_Contains_phone"},null,8,["label"]),l(i(ue),{label:e.$t("org.contacts"),name:"Q_Contains_contacts"},null,8,["label"])]),_:1},8,["params"])]),S("div",null,[l(b,{type:"primary",icon:i(Le),onClick:t[2]||(t[2]=()=>ie())},{default:o(()=>[D(T(e.$t("add")),1)]),_:1},8,["icon"]),l(ke,{title:e.$t("confirmDelete"),onConfirm:t[3]||(t[3]=()=>M(F.value.map(u=>u.id)))},{reference:o(()=>[l(b,{disabled:F.value.length<=0,icon:i(ze)},{default:o(()=>[D(T(e.$t("delete")),1)]),_:1},8,["disabled","icon"])]),_:1},8,["title"]),l(b,{disabled:i(Z)("org:tidyTree"),icon:i(Ke),onClick:t[4]||(t[4]=()=>oe())},{default:o(()=>[D(T(e.$t("tidyTree")),1)]),_:1},8,["disabled","icon"]),l(B,{placement:"top",content:e.$t("tidyTree.tooltip")},{default:o(()=>[l(Ve,{class:"ml-1 text-base align-text-bottom"},{default:o(()=>[l(i(Re))]),_:1})]),_:1},8,["content"]),i(G).globalPermission?(J(),W(qe,{key:0,modelValue:m.value,"onUpdate:modelValue":t[5]||(t[5]=u=>m.value=u),class:"ml-2 align-middle",label:e.$t("globalData"),border:!0,onChange:t[6]||(t[6]=()=>P())},null,8,["modelValue","label"])):ge("",!0),l(i(ol),{name:"org",class:"ml-2"})]),S("div",yl,[$e((J(),W(Se,{id:"dataTable",ref_key:"table",ref:C,"row-key":"id","default-expand-all":"",data:_.value,"row-class-name":({row:u})=>{var se;return((se=u.children)==null?void 0:se.length)>0||u.id==="0"||u.id==="1"?void 0:"drag-draggable"},onSelectionChange:t[7]||(t[7]=u=>F.value=u),onRowDblclick:t[8]||(t[8]=u=>ae(u.id)),onSortChange:fe},{default:o(()=>[l(i(sl),{name:"org"},{default:o(()=>[l(x,{type:"selection",selectable:X,width:"45"}),l(x,{property:"name",label:e.$t("org.name"),sortable:"custom","min-width":"120"},null,8,["label"]),l(x,{property:"address",label:e.$t("org.address"),sortable:"custom",display:"none","min-width":"100"},null,8,["label"]),l(x,{property:"phone",label:e.$t("org.phone"),sortable:"custom","min-width":"100"},null,8,["label"]),l(x,{property:"contacts",label:e.$t("org.contacts"),sortable:"custom"},null,8,["label"]),l(x,{property:"id",label:"ID",width:"170",sortable:"custom"}),l(x,{width:"42"},{default:o(({row:u})=>{var se;return[l(Ve,{class:xe(["text-lg align-middle",K.value||i(Z)("org:update")||((se=u.children)==null?void 0:se.length)>0||u.id==="0"||u.id==="1"?["cursor-not-allowed","text-gray-disabled"]:["cursor-move","text-gray-secondary","drag-handle"]])},{default:o(()=>[l(i(Ge))]),_:2},1032,["class"])]}),_:1}),l(x,{label:e.$t("table.action"),width:"230"},{default:o(({row:u})=>[l(b,{type:"primary",disabled:i(Z)("org:create"),size:"small",link:"",onClick:()=>ie(u.id)},{default:o(()=>[D(T(e.$t("addChild")),1)]),_:2},1032,["disabled","onClick"]),l(b,{type:"primary",disabled:i(Z)("org:update"),size:"small",link:"",onClick:()=>ae(u.id)},{default:o(()=>[D(T(e.$t("edit")),1)]),_:2},1032,["disabled","onClick"]),i(G).epRank>=3||i(G).epDisplay?(J(),W(b,{key:0,title:i(G).epRank<3?e.$t("error.enterprise.short"):void 0,disabled:i(Z)("org:updatePermission")||i(G).epRank<3,type:"primary",size:"small",link:"",onClick:()=>te(u.id)},{default:o(()=>[D(T(e.$t("permissionSettings")),1)]),_:2},1032,["title","disabled","onClick"])):ge("",!0),l(ke,{title:e.$t("confirmDelete"),onConfirm:()=>M([u.id])},{reference:o(()=>[l(b,{type:"primary",disabled:!X(u)||i(Z)("org:delete"),size:"small",link:""},{default:o(()=>[D(T(e.$t("delete")),1)]),_:2},1032,["disabled"])]),_:2},1032,["title","onConfirm"])]),_:1},8,["label"])]),_:1})]),_:1},8,["data","row-class-name"])),[[Ce,L.value]])]),l(ul,{modelValue:I.value,"onUpdate:modelValue":t[9]||(t[9]=u=>I.value=u),"bean-id":y.value,"bean-ids":N.value,"parent-id":z.value,"show-global-data":m.value,onFinished:P},null,8,["modelValue","bean-id","bean-ids","parent-id","show-global-data"]),l(fl,{modelValue:f.value,"onUpdate:modelValue":t[10]||(t[10]=u=>f.value=u),"bean-id":y.value,"show-global-data":m.value,onFinished:P},null,8,["modelValue","bean-id","show-global-data"])]),_:1})]),_:1})}}});export{Dl as default};
